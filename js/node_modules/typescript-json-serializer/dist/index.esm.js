import{__spreadArray as e,__assign as t}from"tslib";import"reflect-metadata";var r,a="api:map:";!function(e){e.Array="array",e.Boolean="boolean",e.Date="date",e.Number="number",e.Object="object",e.String="string"}(r||(r={}));var n=function(t){var r=Reflect.getPrototypeOf(t);return r&&r.name?e(e([],n(r)),[r.name]):[]},i=function(e){return function(t,r,n){if(void 0===r&&t.prototype){var i=Reflect.getMetadata("design:paramtypes",t)[n];r=function(e){var t=e.toString().split("}")[0].replace(/(\/\*[\s\S]*?\*\/|\/\/.*$)/gm,"").replace(/[\r\t\n\v\f ]/g,""),r=/(?:this\.)([^,;\n}]+)/gm,a=new Map,n=/(?:.*(?:constructor|function).*?(?=\())(?:\()(.+?(?=\)))/m.exec(t);if(!n||!n.length)return a;for(var i,o=n[1].split(","),c=function(){var e=i[1].split("="),t=o.findIndex((function(t){return t===e[1]}));t>-1&&a.set(t,e[0])};i=r.exec(t);)c();return a}(t.prototype.constructor).get(n),t=t.prototype,Reflect.defineMetadata("design:type",i,t,r)}var o={},c=t.constructor.name,f=""+a+c;Reflect.hasMetadata(f,t)&&(o=Reflect.getMetadata(f,t)),o[r]=m(r,e),Reflect.defineMetadata(f,o,t)}},o=function(e){return function(t){var r=n(t);Reflect.defineMetadata("api:map:serializable",{baseClassNames:r,options:e},t)}},c=function(e,t){return e.map((function(e){return Reflect.getMetadata(""+a+e,t)}))},f=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var a={};return e.forEach((function(e){e&&Object.keys(e).forEach((function(r){a[r]=t(t({},a[r]),e[r])}))})),a},s=function(t,n){var i;if([null,void 0].includes(t))return t;if(void 0===n)return v(typeof t,t);typeof t===r.String&&(t=JSON.parse(t));var o=new n,s=o.constructor.name,u=null!==(i=Reflect.getMetadata("api:map:serializable",n))&&void 0!==i?i:{},l=u.baseClassNames,d=u.options,m=""+a+s,y=Reflect.hasMetadata(m,o),g={};if(!(y||l&&l.length))return o;if(g=Reflect.getMetadata(m,o),l&&l.length){var b=c(l,o);g=f.apply(void 0,e(e([],b),[g]))}return Object.keys(g).forEach((function(e){var r=p(o,e,g[e],t,null==d?void 0:d.formatPropertyNames);if(null==r&&g[e].required)throw new Error("Property '"+e+"' is required in "+s+" "+JSON.stringify(t)+".");void 0!==r&&(o[e]=r)})),o},u=function(t,n){var i;if(void 0===n&&(n=!0),[void 0,null].includes(t)||typeof t!==r.Object)return t;var o=t.constructor.name,s=""+a+o,u=null!==(i=Reflect.getMetadata("api:map:serializable",t.constructor))&&void 0!==i?i:{},p=u.baseClassNames,d=u.options,m=p&&p.length,v=Reflect.hasMetadata(s,t),y={};if(!v&&!m)return t;if(y=Reflect.getMetadata(s,t),m){var g=c(p,t);y=f.apply(void 0,e(e([],g),[y]))}var b={},h=Object.keys(t);return Object.keys(y).forEach((function(e){if(h.includes(e)){var r=y[e],a=r.beforeSerialize,i=r.afterSerialize,o=void 0;a&&(o=t[e],t[e]=a(t[e],t));var c=l(t,e,r,n);if(i&&(c=i(c,t)),t[e]=o||t[e],r.names)r.names.forEach((function(e){(!n||n&&void 0!==c[e])&&(b[e]=c[e])}));else if(!n||n&&void 0!==c)if(!r.isNameOverridden&&(null==d?void 0:d.formatPropertyNames)){var f=d.formatPropertyNames(r.name);b[f]=c}else b[r.name]=c}})),b},l=function(e,t,a,n){var i=e[t],o=Reflect.getMetadata("design:type",e,t),c=!!o.name&&o.name.toLocaleLowerCase()===r.Array,f=a.predicate,s=a.type||o,l=d(s);if(i&&(l||f)){if(c)return i.map((function(e){return u(e,n)}));if(a.isDictionary){var p={};return Object.keys(i).forEach((function(e){p[e]=u(i[e],n)})),p}return u(i,n)}return s.name.toLocaleLowerCase()===r.Date&&typeof i===r.Object?i.toISOString():i},p=function(e,t,a,n,i){var o;if([null,void 0].includes(n))return n;if("names"in a){var c={};a.names.forEach((function(e){return c[e]=n[e]})),o=c}else if("name"in a&&!a.isNameOverridden&&i){var f=i(a.name);o=n[f]}else o=n[a.name];if([null,void 0].includes(o))return o;var u,l=Reflect.getMetadata("design:type",e,t),p=!!l.name&&l.name.toLowerCase()===r.Array,m=a.isDictionary,y=a.predicate,g=a.beforeDeserialize,b=a.afterDeserialize,h=a.type||l,O=d(h);if(g&&(o=g(o,e)),m){var N={};typeof o!==r.Object?(console.error("Type '"+typeof o+"' is not assignable to type 'Dictionary' for property '"+t+"' in '"+e.constructor.name+"'.\n","Received: "+JSON.stringify(o)),u=void 0):(Object.keys(o).forEach((function(r){O||y?(y&&(h=y(o[r],o)),N[r]=s(o[r],h)):N[r]=v(typeof o[r],o[r],t,e.constructor.name)})),u=N)}else if(p){var R=[];Array.isArray(o)?(o.forEach((function(r){O||y?(y&&(h=y(r,o)),R.push(s(r,h))):R.push(v(typeof r,r,t,e.constructor.name))})),u=R):(console.error("Type '"+typeof o+"' is not assignable to type 'Array' for property '"+t+"' in '"+e.constructor.name+"'.\n","Received: "+JSON.stringify(o)),u=void 0)}else O||y?(h=y?y(o,n):h,u=s(o,h)):u=v(h.name,o,t,e.constructor.name);return b&&(u=b(u,e)),u},d=function(e){return Reflect.hasOwnMetadata("api:map:serializable",e)},m=function(e,t){if(!t)return{name:e.toString(),isNameOverridden:!1};var a;a=typeof t===r.String?{name:t,isNameOverridden:!0}:t.name?{name:t.name,isNameOverridden:!0}:t.names&&t.names.length?{names:t.names}:{name:e.toString(),isNameOverridden:!1};return["isDictionary","required","beforeSerialize","afterSerialize","beforeDeserialize","afterDeserialize"].forEach((function(e){void 0!==t[e]&&null!==t[e]&&(a[e]=t[e])})),t.predicate?a.predicate=t.predicate:t.type&&(a.type=t.type),a},v=function(e,t,a,n){if(null==e)return t;if(e=e.toLowerCase(),(typeof t).toLowerCase()===e)return t;var i=function(){console.error("Type '"+typeof t+"' is not assignable to type '"+e+"' for property '"+a+"' in '"+n+"'.\n","Received: "+JSON.stringify(t))};switch(e){case r.String:var o=t.toString();return"[object Object]"===o?void i():o;case r.Number:var c=+t;return isNaN(c)?void i():c;case r.Boolean:return void i();case r.Date:return isNaN(Date.parse(t))?void i():new Date(t);default:return t}};export{i as JsonProperty,o as Serializable,s as deserialize,u as serialize};
